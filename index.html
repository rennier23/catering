<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KPIs — Dashboard Azul/Branco</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{--azul:#0b3a8a;--azul-esc:#082a66;--azul-claro:#e8f0ff;--borda:#cfe0ff;--grad-a:#2b6cff;--grad-b:#5bbcff}
html,body{background:#fff;color:#0f172a}
.brand-grad{background:linear-gradient(90deg,var(--azul),#1673ff)}
.tab,.pill{display:inline-flex;align-items:center;gap:6px;font-size:12px;padding:.44rem .9rem;border-radius:999px;border:1px solid var(--borda);background:#fff;color:#0b3a8a;transition:.2s;white-space:nowrap;text-decoration:none}
.tab:hover,.pill:hover{background:#f7fbff}
.tab[aria-current="page"],.pill[aria-pressed="true"]{background:linear-gradient(135deg,var(--grad-a),var(--grad-b));color:#fff;border:0;box-shadow:0 4px 12px rgba(30,94,220,.25)}
.tab svg{width:14px;height:14px;color:currentColor}
.tab[aria-current="page"] svg{filter:drop-shadow(0 1px 0 rgba(0,0,0,.2))}
.btn{font-size:12px;border:1px solid var(--borda);background:#fff;color:#0b3a8a;padding:.44rem .75rem;border-radius:.55rem}
.btn:hover{background:#f3f7ff}
.btn-primary{background:var(--azul);color:#fff;border-color:var(--azul)}
.combo-nav{display:flex;align-items:center;gap:8px;overflow-x:auto;padding:6px 0 4px}
#unitsBar{display:flex;gap:8px;margin-left:12px}
#cards{display:flex !important;gap:12px;align-items:stretch;overflow:visible;--cardW:180px}
#cards>div{width:var(--cardW);min-width:96px}
.kpi-card{border-radius:12px;padding:.60rem .65rem}
.kpi-card .text-lg{font-size:clamp(13px,1.5vw,18px)}
.ok{border-left:6px solid #16a34a;background:#dcfce7}
.warn{border-left:6px solid #f59e0b;background:#fef3c7}
.bad{border-left:6px solid #ef4444;background:#fee2e2}
.neutral{border-left:6px solid #94a3b8;background:#f1f5f9}
table.kpi{table-layout:fixed;width:100%;border-collapse:separate;border-spacing:0}
table.kpi th,table.kpi td{padding:.40rem .45rem;font-size:11px;line-height:1.15;text-align:center;vertical-align:middle}
table.kpi thead th{position:sticky;top:0;z-index:1;background:var(--azul-esc);color:#fff}
table.kpi tbody tr td{border-bottom:1px solid #e5edff}
.col-unidade{min-width:100px}.col-data{min-width:110px}.col-num{min-width:80px}
#secRH table.kpi th,#secRH table.kpi td,#secTransp table.kpi th,#secTransp table.kpi td{font-size:clamp(10px,0.9vw,12px);padding:clamp(.22rem,.5vw,.38rem) clamp(.28rem,.6vw,.45rem)}
#secRH .col-unidade,#secTransp .col-unidade{min-width:90px}
#secRH .col-data,#secTransp .col-data{min-width:96px}
#secRH .col-num,#secTransp .col-num{min-width:66px}
@media (max-width:1366px){
  #secRH table.kpi th,#secRH table.kpi td,#secTransp table.kpi th,#secTransp table.kpi td{font-size:clamp(9px,0.85vw,11px)}
  #secRH .col-num,#secTransp .col-num{min-width:58px}
}
.legend-dot{width:10px;height:10px;border-radius:999px;display:inline-block;margin-right:.35rem}
.dot-ok{background:#16a34a}.dot-warn{background:#f59e0b}.dot-bad{background:#ef4444}
</style>
</head>
<body>
<header class="brand-grad text-white">
  <div class="max-w-[1500px] mx-auto px-4 py-3">
    <div class="flex flex-wrap items-center gap-3">
      <div class="flex items-center gap-2 pr-4 mr-2 border-r border-white/20">
        <svg width="26" height="26" viewBox="0 0 24 24" class="opacity-90" aria-hidden="true"><path fill="currentColor" d="M3 3h8v8H3zm10 0h8v8h-8zM3 13h8v8H3zm10 0h8v8h-8z" opacity=".3"/><path fill="currentColor" d="M4 4h6v6H4zm10 0h6v6h-6zM4 14h6v6H4zm10 0h6v6h-6z"/></svg>
        <div>
          <h1 class="text-base font-semibold">KPIs — Armazém | RH | Transporte</h1>
          <p class="text-[12px] opacity-90">Filtro único • Navegação por blocos • Metas com cores</p>
        </div>
      </div>

      <div class="flex items-center gap-2 flex-wrap">
        <label class="text-[12px]">Data início
          <input id="dateStart" type="date" class="text-xs border rounded px-2 py-1 h-8 text-slate-800"/>
        </label>
        <label class="text-[12px]">Data fim
          <input id="dateEnd" type="date" class="text-xs border rounded px-2 py-1 h-8 text-slate-800"/>
        </label>
        <label class="btn bg-white cursor-pointer">Carregar CSV
          <input id="csvInput" type="file" accept=".xlsx,.xls,.csv" class="hidden"/>
        </label>
        <button id="btnMetas" class="btn btn-primary" type="button">Metas de KPI</button>
        <button id="btnReset" class="btn bg-white" type="button">Resetar filtros</button>
      </div>
    </div>

    <nav class="combo-nav mt-3" aria-label="Navegação">
      <a href="#arm" id="tabArm" class="tab" aria-current="page">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 10.5V8.9l9-4.8 9 4.8v1.6l-9-4.6-9 4.6Z"/><path fill="currentColor" d="M5 11h14v8H5zM7 13h4v4H7z"/></svg>
        Armazém
      </a>
      <a href="#rh" id="tabRH" class="tab">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-3.33 0-6 1.67-6 3.75V20h12v-2.25C18 15.67 15.33 14 12 14Z"/></svg>
        RH
      </a>
      <a href="#transp" id="tabTransp" class="tab">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M3 6h11v9H3zM14 9h4l3 3v3h-7z"/><circle cx="7" cy="18" r="2" fill="currentColor"/><circle cx="17" cy="18" r="2" fill="currentColor"/></svg>
        Transporte
      </a>
      <div id="unitsBar"></div>
    </nav>
  </div>
</header>

<main class="max-w-[1500px] mx-auto px-4 py-4">
  <details class="mb-4 bg-[var(--azul-claro)] border border-[var(--borda)] rounded-xl p-3">
    <summary class="font-medium text-[13px] text-[var(--azul)] cursor-pointer">Legenda e detalhes</summary>
    <div class="mt-2 text-[13px] text-slate-700 leading-6">
      <div class="flex flex-wrap gap-4">
        <div><span class="legend-dot dot-ok"></span>Meta atingida</div>
        <div><span class="legend-dot dot-warn"></span>Atenção</div>
        <div><span class="legend-dot dot-bad"></span>Abaixo da meta</div>
      </div>
      <ul class="list-disc pl-5 mt-2">
        <li><strong>Sem meta</strong>: Volume In/Out, Largada total, Largada no horário, Volume.</li>
        <li><strong>Meta</strong>: % On-time (95% padrão), Contagem, ILA, IRA, Perdas, Ocupação, OT/IF/Fill Rate D-1, Turnover, Absenteísmo.</li>
      </ul>
    </div>
  </details>

  <section id="metasBadges" class="flex flex-wrap gap-2 mb-4"></section>
  <section id="cards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 mb-5"></section>

  <section id="secArm" class="bg-white rounded-2xl border border-[var(--borda)]">
    <div class="px-3 py-2 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h2 class="text-[12px] font-semibold text-[var(--azul)] uppercase">ARMAZÉM</h2>
      <span id="rowsArm" class="text-[12px] text-slate-600"></span>
    </div>
    <div class="p-2">
      <table class="kpi"><thead id="theadArm"></thead><tbody id="tbodyArm"></tbody></table>
    </div>
  </section>

  <section id="secRH" class="bg-white rounded-2xl border border-[var(--borda)] hidden">
    <div class="px-3 py-2 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h2 class="text-[12px] font-semibold text-[var(--azul)] uppercase">RH</h2>
      <span id="rowsRH" class="text-[12px] text-slate-600"></span>
    </div>
    <div class="p-2">
      <table class="kpi"><thead id="theadRH"></thead><tbody id="tbodyRH"></tbody></table>
    </div>
  </section>

  <section id="secTransp" class="bg-white rounded-2xl border border-[var(--borda)] hidden">
    <div class="px-3 py-2 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h2 class="text-[12px] font-semibold text-[var(--azul)] uppercase">TRANSPORTE</h2>
      <span id="rowsTransp" class="text-[12px] text-slate-600"></span>
    </div>
    <div class="p-2">
      <table class="kpi"><thead id="theadTransp"></thead><tbody id="tbodyTransp"></tbody></table>
    </div>
  </section>
</main>

<dialog id="modalMetas" class="rounded-2xl p-0 w-[560px] max-w-[95vw]">
  <form method="dialog" class="bg-white rounded-2xl border border-[var(--borda)]">
    <div class="px-4 py-3 border-b border-[var(--borda)] bg-[var(--azul-claro)] flex items-center justify-between">
      <h3 class="text-sm font-semibold text-[var(--azul)]">Metas de KPI</h3>
      <button id="closeMetas" class="btn" type="button">Fechar</button>
    </div>
    <div class="p-4 grid grid-cols-2 gap-3 text-xs">
      <label class="grid gap-1"><span>ON TIME D-1 (%)</span><input id="m_onTime" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>IN FULL D-1 (%)</span><input id="m_inFull" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>FILL RATE D-1 (%)</span><input id="m_fillRate" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Contagem cíclica</span><input id="m_contagem" type="number" min="0" step="1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>ILA (%)</span><input id="m_ila" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>IRA (%)</span><input id="m_ira" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Perdas (%)</span><input id="m_perdas" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Ocupação (%)</span><input id="m_ocupacao" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Turnover (%)</span><input id="m_turnover" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
      <label class="grid gap-1"><span>Absenteísmo (%)</span><input id="m_abs" type="number" min="0" max="100" step="0.1" class="border rounded px-2 py-1"></label>
    </div>
    <div class="px-4 py-3 border-t border-[var(--borda)] flex justify-end gap-2">
      <button id="btnSalvarMetas" class="btn btn-primary" type="button">Salvar metas</button>
    </div>
  </form>
</dialog>

<!-- === DADOS EMBUTIDOS (OPCIONAL) === -->
<script id="seed-data" type="application/json">[]</script>

<script>
/* ===== CONFIG ===== */
const LS_METAS='kpiTargets_blue_v1';
const defaultTargets={onTime:95,inFull:95,fillRate:95,contagem:95,ila:95,ira:95,perdas:8,ocupacao:85,turnover:3,abs:3};
const ROUTES={arm:'arm',rh:'rh',transp:'transp'}; let activeBlock=ROUTES.arm;

/* === NOVO: Excel estático do repositório === */
const EXCEL_URL = "data/base.xlsx";   // coloque seu arquivo em /data/base.xlsx
const EXCEL_SHEET = "Base";           // nome da aba; use null para a primeira

/* COLUNAS */
const HEAD_ARM=["Unidade","Data","Volume In (tons)","Volume Out (tons)","Corte (KG)","Contagem cíclica","ILA %","IRA %","Paletes Pendentes","Perdas (avarias e diferença de estoque)"];
const HEAD_RH=["Unidade","Data","HE armazém e transporte","Turnover","Absenteísmo","Custo MOT (armazém e transporte)"];
const HEAD_TRANSP=["Unidade","Data","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","% On-time (calc)","Volume (tons)","Ocupação","Reentrega","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Indisponibilidade de Frota (%)"];

/* TIPAGEM/FORMATO */
const pctCols=new Set([
  "ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo",
  "Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"
]);
const intCols=new Set(["Paletes Pendentes","Horas Extras Armazém","Horas Extras Transporte","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1"]);
const moneyCols=new Set(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"]);
const tonsCols=new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
const kgCols=new Set(["Corte (KG)"]);

/* ==== UTILS ==== */
const isDash = v => typeof v === 'string' && v.trim().match(/^[-–—]+$/);
const toISODateLocal = (y,m,d) => `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
const fmt={
  num:v=>(v??v===0)?Number(v).toLocaleString('pt-BR'):'',
  money:v=>(v??v===0)?Number(v).toLocaleString('pt-BR',{style:'currency',currency:'BRL',maximumFractionDigits:0}):'',
  pct:v=>(v??v===0)?`${Number(v).toFixed(1).replace('.',',')}%`:'',
  date:s=>!s?'':String(s).replace(/^(\d{4})-(\d{2})-(\d{2})$/,(a,Y,M,D)=>`${D}/${M}/${Y}`)
};
const parseDateRaw = s=>{
  if(!s) return new Date('invalid');
  const iso=String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/); if(iso) return new Date(+iso[1],+iso[2]-1,+iso[3]);
  const dmY=String(s).match(/^(\d{2})[./](\d{2})[./](\d{4})$/); if(dmY) return new Date(+dmY[3],+dmY[2]-1,+dmY[1]);
  return new Date(s);
};
const asNumber=(v)=>{ if(v===null||v===undefined) return ''; const s=String(v).trim(); if(s===''||isDash(s)) return ''; const n=Number(s.replace(/R\$\s?/i,'').replace(/\./g,'').replace(',','.').replace(/%/g,'')); return Number.isFinite(n)?n:''; };
const asDateISO=(v)=>{ if(v==null||v===''||isDash(v)) return ''; if(typeof v==='number'){const d=XLSX.SSF.parse_date_code(v); if(!d) return ''; return toISODateLocal(d.y,d.m,d.d);} const s=String(v).trim(); const m=s.match(/^(\d{2})[./](\d{2})[./](\d{4})$/); if(m) return toISODateLocal(+m[3],+m[2]-1,+m[1]); const dt=new Date(s); return isNaN(dt)?'':toISODateLocal(dt.getFullYear(),dt.getMonth()+1,dt.getDate()); };

/* Normalizador de % */
function normPct(v){
  if(v===''||v==null) return '';
  let n=Number(String(v).replace('%','').replace(/\s/g,'').replace(',','.'));
  if(!Number.isFinite(n)) return '';
  if(n>0 && n<=1) return n*100;
  if(n<=100) return n;
  while(n>100) n/=10;
  return n;
}

/* === EMBED JSON opcional === */
function getSeedData(){
  const el=document.getElementById('seed-data');
  if(!el) return [];
  let raw=[];
  try{ raw = JSON.parse(el.textContent||'[]'); }catch(e){ return []; }
  if(!Array.isArray(raw) || !raw.length) return [];
  return raw.map(normalizeRow).filter(o=>!isRowAllBlank(o));
}
let DATA = getSeedData();

/* ELEMENTOS */
const els={dateStart:document.getElementById('dateStart'),dateEnd:document.getElementById('dateEnd'),csvInput:document.getElementById('csvInput'),btnMetas:document.getElementById('btnMetas'),modalMetas:document.getElementById('modalMetas'),closeMetas:document.getElementById('closeMetas'),btnSalvarMetas:document.getElementById('btnSalvarMetas'),btnReset:document.getElementById('btnReset'),metasBadges:document.getElementById('metasBadges'),cards:document.getElementById('cards'),unitsBar:document.getElementById('unitsBar'),tabArm:document.getElementById('tabArm'),tabRH:document.getElementById('tabRH'),tabTransp:document.getElementById('tabTransp'),secArm:document.getElementById('secArm'),secRH:document.getElementById('secRH'),secTransp:document.getElementById('secTransp'),theadArm:document.getElementById('theadArm'),tbodyArm:document.getElementById('tbodyArm'),theadRH:document.getElementById('theadRH'),tbodyRH:document.getElementById('tbodyRH'),theadTransp:document.getElementById('theadTransp'),tbodyTransp:document.getElementById('tbodyTransp'),rowsArm:document.getElementById('rowsArm'),rowsRH:document.getElementById('rowsRH'),rowsTransp:document.getElementById('rowsTransp')};
const {dateStart,dateEnd,csvInput,btnMetas,modalMetas,closeMetas,btnSalvarMetas,btnReset,metasBadges,cards,unitsBar,tabArm,tabRH,tabTransp,secArm,secRH,secTransp,theadArm,tbodyArm,theadRH,tbodyRH,theadTransp,tbodyTransp,rowsArm,rowsRH,rowsTransp}=els;

/* UNIDADES */
let UNIT_STATE=[];
function renderUnits(list){
  const units=Array.from(new Set(list.map(r=>r.Unidade))).sort();
  const prev=new Map(UNIT_STATE.map(x=>[x.u,x.on]));
  UNIT_STATE=units.map(u=>({u,on:prev.has(u)?prev.get(u):true}));
  unitsBar.innerHTML='';
  const allBtn=document.createElement('button'); allBtn.type='button'; allBtn.className='pill'; allBtn.textContent='Todas';
  allBtn.setAttribute('aria-pressed', UNIT_STATE.every(x=>x.on)?'true':'false');
  allBtn.addEventListener('click',()=>{const makeOn=!UNIT_STATE.every(x=>x.on); UNIT_STATE.forEach(x=>x.on=makeOn); updateUnitPills(); refresh();});
  unitsBar.appendChild(allBtn);
  units.forEach(u=>{const b=document.createElement('button'); b.type='button'; b.className='pill'; b.textContent=u; b.dataset.u=u;
    b.setAttribute('aria-pressed', UNIT_STATE.find(x=>x.u===u)?.on?'true':'false');
    b.addEventListener('click',()=>{const item=UNIT_STATE.find(x=>x.u===u); item.on=!item.on; updateUnitPills(); refresh();});
    unitsBar.appendChild(b);
  });
}
function updateUnitPills(){unitsBar.querySelectorAll('.pill').forEach(btn=>{ if(btn.textContent==='Todas'){btn.setAttribute('aria-pressed', UNIT_STATE.every(x=>x.on)?'true':'false');} else {const on=UNIT_STATE.find(x=>x.u===btn.dataset.u)?.on; btn.setAttribute('aria-pressed', on?'true':'false');}});}
function selectedUnits(){return UNIT_STATE.filter(x=>x.on).map(x=>x.u);}

/* FILTROS */
function applyFilters(data){
  let out=data.slice();
  const ds=dateStart.value?parseDateRaw(dateStart.value):null;
  const de=dateEnd.value?parseDateRaw(dateEnd.value):null;
  if(ds) out=out.filter(r=>parseDateRaw(r.Data)>=ds);
  if(de){const e=new Date(de); e.setHours(23,59,59,999); out=out.filter(r=>parseDateRaw(r.Data)<=e);}
  const units=selectedUnits();
  if(units.length && units.length!==UNIT_STATE.length) out=out.filter(r=>units.includes(r.Unidade));
  return out;
}

/* ENRIQUECIMENTO/SUMÁRIO */
function enrich(r){
  const vin=asNumber(r["Volume In (tons)"])||0, vout=asNumber(r["Volume Out (tons)"])||0;
  if(vin>0||vout>0) r["Volume (tons)"]= r["Volume (tons)"]!=='' ? r["Volume (tons)"] : (vin+vout);
  const hea=asNumber(r["Horas Extras Armazém"]), het=asNumber(r["Horas Extras Transporte"]);
  r["HE armazém e transporte"]=(hea!==''||het!=='')?((hea||0)+(het||0)):''; 
  const lt=asNumber(r["Largada (Total de veículos)"])||0, ln=asNumber(r["Largada (Veículos que saíram no horario)"])||0;
  r["% On-time (calc)"]=lt>0?(ln/lt)*100:'';
  if(r["Custo MOT (armazém e transporte)"]===''||r["Custo MOT (armazém e transporte)"]==null) r["Custo MOT (armazém e transporte)"]='';
  return r;
}
function summarize(list){
  const acc={count:list.length,sum:{},avg:{}};
  const sumCols=["Volume In (tons)","Volume Out (tons)","Volume (tons)","Corte (KG)","Paletes Pendentes","Horas Extras Armazém","Horas Extras Transporte","HE armazém e transporte","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"];
  const avgCols=["Contagem cíclica","ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"];
  sumCols.forEach(k=>acc.sum[k]=0); avgCols.forEach(k=>acc.avg[k]=0);
  list.forEach(r=>{ sumCols.forEach(k=>acc.sum[k]+=Number(r[k])||0); avgCols.forEach(k=>{const v=Number(r[k]); if(!isNaN(v)) acc.avg[k]+=v;}); });
  avgCols.forEach(k=>{const validCount = list.filter(r => !isNaN(Number(r[k])) && r[k] !== '').length; acc.avg[k] = validCount ? acc.avg[k] / validCount : null;});
  const lt=acc.sum["Largada (Total de veículos)"], ln=acc.sum["Largada (Veículos que saíram no horario)"];
  if(lt>0) acc.avg["% On-time (calc)"]=(ln/lt)*100;
  return acc;
}

/* METAS/STATUS */
const targetMap={"Contagem cíclica":{k:"contagem",inverse:false},"ILA %":{k:"ila",inverse:false},"IRA %":{k:"ira",inverse:false},"Perdas (avarias e diferença de estoque)":{k:"perdas",inverse:true},"Turnover":{k:"turnover",inverse:true},"Absenteísmo":{k:"abs",inverse:true},"Ocupação":{k:"ocupacao",inverse:false},"ON TIME D-1":{k:"onTime",inverse:false},"IN FULL D-1":{k:"inFull",inverse:false},"FILL RATE D-1":{k:"fillRate",inverse:false},"% On-time (calc)":{k:"onTime",inverse:false}};
const getTargets=()=>{const raw=localStorage.getItem(LS_METAS);return raw?{...defaultTargets,...JSON.parse(raw)}:{...defaultTargets}};
const saveTargets=t=>localStorage.setItem(LS_METAS,JSON.stringify(t));
function statusOf(metric,value){ const t=getTargets(); const conf=targetMap[metric]; if(!conf) return 'neutral'; const target=Number(t[conf.k]); if(isNaN(target)||value==null||value==='') return 'neutral'; if(!conf.inverse){ if(value>=target) return 'ok'; if(value>=target*0.95) return 'warn'; return 'bad'; } else { if(value<=target) return 'ok'; if(value<=target*1.10) return 'warn'; return 'bad'; } }

/* RENDER */
function renderBadges(){ const t=getTargets(); const items=[["On-time",t.onTime],["Fill Rate",t.fillRate],["In Full",t.inFull],["Contagem",t.contagem],["ILA",t.ila],["IRA",t.ira],["Perdas (máx)",t.perdas],["Ocupação",t.ocupacao],["Turnover (máx)",t.turnover],["Absenteísmo (máx)",t.abs]]; metasBadges.innerHTML=''; items.forEach(([k,v])=>{const s=document.createElement('span'); s.className='pill'; s.textContent=`${k}: ${v}%`; metasBadges.appendChild(s);}); }
function cardHTML(label,value,type,metricKeyForStatus){ let txt=''; if(type==='money')txt=fmt.money(value); else if(type==='pct')txt=fmt.pct(value); else txt=fmt.num(value); const st=metricKeyForStatus?statusOf(metricKeyForStatus,Number(value)):'neutral'; return `<div class="${st} rounded-xl p-3 border"><div class="text-[12px] text-slate-700">${label}</div><div class="mt-1 text-lg font-semibold text-slate-900">${txt||'-'}</div></div>`; }
function renderCardsFor(block,sum){
  let cardsArr=[];
  if(block===ROUTES.arm){
    cardsArr=[
      ['Volume In (t)',sum.sum["Volume In (tons)"],'num',null],
      ['Volume Out (t)',sum.sum["Volume Out (tons)"],'num',null],
      ['Corte (KG)',sum.sum["Corte (KG)"],'num',null],
      ['Contagem cíclica',sum.avg["Contagem cíclica"],'num',"Contagem cíclica"],
      ['ILA %',sum.avg["ILA %"],'pct',"ILA %"],
      ['IRA %',sum.avg["IRA %"],'pct',"IRA %"],
      ['Paletes Pendentes',sum.sum["Paletes Pendentes"],'num',null],
      ['Perdas (%)',sum.avg["Perdas (avarias e diferença de estoque)"],'pct',"Perdas (avarias e diferença de estoque)"]
    ];
  }else if(block===ROUTES.rh){
    cardsArr=[
      ['HE total',sum.sum["HE armazém e transporte"],'num',null],
      ['Turnover %',sum.avg["Turnover"],'pct',"Turnover"],
      ['Absenteísmo %',sum.avg["Absenteísmo"],'pct',"Absenteísmo"],
      ['Custo MOT (R$)',sum.sum["Custo MOT (armazém e transporte)"],'money',null]
    ];
  }else{
    cardsArr=[
      ['Largada total',sum.sum["Largada (Total de veículos)"],'num',null],
      ['No horário',sum.sum["Largada (Veículos que saíram no horario)"],'num',null],
      ['On-time %',sum.avg["% On-time (calc)"],'pct',"% On-time (calc)"],
      ['Volume (t)',sum.sum["Volume (tons)"],'num',null],
      ['Ocupação %',sum.avg["Ocupação"],'pct',"Ocupação"],
      ['Reentrega',sum.sum["Reentrega"],'num',null],
      ['ON TIME D-1 %',sum.avg["ON TIME D-1"],'pct',"ON TIME D-1"],
      ['IN FULL D-1 %',sum.avg["IN FULL D-1"],'pct',"IN FULL D-1"],
      ['FILL RATE D-1 %',sum.avg["FILL RATE D-1"],'pct',"FILL RATE D-1"],
      ['Indisp. Frota %',sum.avg["Indisponibilidade de Frota (%)"],'pct',null],
      ['Ocorrências (R$)',sum.sum["Ocorrências em R$ D-1"],'money',null],
      ['Ocorrências (qtd)',sum.sum["Ocorrências quantidade D-1"],'num',null]
    ];
  }
  cards.innerHTML=cardsArr.map(c=>cardHTML(c[0],c[1],c[2],c[3])).join('');
}
function renderHead(theadEl,HEADERS){ const tr=document.createElement('tr'); HEADERS.forEach((h,i)=>{const th=document.createElement('th'); th.className=(i===0?'col-unidade':i===1?'col-data':'col-num'); th.textContent=h; tr.appendChild(th);}); theadEl.innerHTML=''; theadEl.appendChild(tr); }
function renderBody(tbodyEl,HEADERS,list,rowsInfoEl){
  const frag=document.createDocumentFragment();
  list.forEach(r=>{
    const tr=document.createElement('tr');
    HEADERS.forEach((h)=>{
      let v=r[h];
      if(h==="Data") v=fmt.date(v);
      if(h==="Volume (tons)"&&(v==null||v==='')){ const vin=asNumber(r["Volume In (tons)"])||0; const vout=asNumber(r["Volume Out (tons)"])||0; if(vin>0||vout>0) v=vin+vout; }
      let txt=''; if(pctCols.has(h)) txt=fmt.pct(v); else if(moneyCols.has(h)) txt=fmt.money(v);
      else if(kgCols.has(h)||tonsCols.has(h)||intCols.has(h)) txt=fmt.num(v); else txt=(v??'')+'';
      const st=statusOf(h,Number(v));
      const td=document.createElement('td'); td.className=(st!=='neutral'?' '+st+' rounded-md border':''); td.textContent=txt; tr.appendChild(td);
    });
    frag.appendChild(tr);
  });
  tbodyEl.innerHTML=''; tbodyEl.appendChild(frag);
  if(rowsInfoEl) rowsInfoEl.textContent=list.length+" linha(s)";
}

/* NAVEGAÇÃO */
function getActiveFromHash(){ const h=(location.hash||'#arm').replace('#',''); if(h===ROUTES.rh) return ROUTES.rh; if(h===ROUTES.transp) return ROUTES.transp; return ROUTES.arm; }
function setActiveBlock(block){ activeBlock=block; tabArm.setAttribute('aria-current',block===ROUTES.arm?'page':'false'); tabRH.setAttribute('aria-current',block===ROUTES.rh?'page':'false'); tabTransp.setAttribute('aria-current',block!==ROUTES.transp?'false':'page'); secArm.classList.toggle('hidden',block!==ROUTES.arm); secRH.classList.toggle('hidden',block!==ROUTES.rh); secTransp.classList.toggle('hidden',block!==ROUTES.transp); refresh(); }
window.addEventListener('hashchange',()=>setActiveBlock(getActiveFromHash()));

/* IMPORTAÇÃO / NORMALIZAÇÃO */
const PCT = new Set(["ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","% On-time (calc)","Indisponibilidade de Frota (%)"]);
const MONEY = new Set(["Ocorrências em R$ D-1","Custo MOT (armazém e transporte)"]);
const INTLIKE = new Set(["Paletes Pendentes","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Horas Extras Armazém","Horas Extras Transporte"]);
const TONS = new Set(["Volume In (tons)","Volume Out (tons)","Volume (tons)"]);
const KEY_NUMERIC = new Set(["Volume In (tons)","Volume Out (tons)","Corte (KG)","Paletes Pendentes","Largada (Total de veículos)","Largada (Veículos que saíram no horario)","Reentrega","Ocorrências quantidade D-1","Ocorrências em R$ D-1","Contagem cíclica","ILA %","IRA %","Perdas (avarias e diferença de estoque)","Turnover","Absenteísmo","Ocupação","ON TIME D-1","IN FULL D-1","FILL RATE D-1","Indisponibilidade de Frota (%)","Volume (tons)"]);

const normalizeRow=(row)=>{
  const o={};
  for(const k in row){ const key=String(k).trim(); const val=isDash(row[k])?'':row[k]; o[key]=val; }
  if(o["Indisponibilidade de Frota"]!==undefined && o["Indisponibilidade de Frota (%)"]===undefined) o["Indisponibilidade de Frota (%)"]=o["Indisponibilidade de Frota"];
  o["Data"]=asDateISO(o["Data"]);

  Object.keys(o).forEach(k=>{
    if(PCT.has(k)) { o[k]=normPct(o[k]); return; }
    if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k)) { const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n; }
    if(k==="Contagem cíclica"){ const n=asNumber(o[k]); o[k]=(n===''||!Number.isFinite(n))?'':n; }
  });

  if(o["Volume (tons)"]===''||o["Volume (tons)"]==null){
    const vin=asNumber(o["Volume In (tons)"])||0, vout=asNumber(o["Volume Out (tons)"])||0;
    o["Volume (tons)"]=(vin>0||vout>0)?(vin+vout):'';
  }
  return o;
};
const isRowAllBlank=(o)=>{
  if(!o["Unidade"]||!o["Data"]) return true;
  for(const k of KEY_NUMERIC){ const v=o[k]; if(v!=='' && Number(v)!==0) return false; }
  return true;
};

/* CSV (fallback manual) */
function parseCSV(text){
  const delimiter=text.indexOf(';')>-1?';':',';
  const lines=text.trim().split(/\r?\n/);
  const headers=lines[0].split(delimiter).map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const cols=[]; let cur='',inQ=false;
    for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){inQ=!inQ;continue;} if(!inQ&&ch===delimiter){cols.push(cur);cur='';continue;} cur+=ch; }
    cols.push(cur);
    const obj={}; headers.forEach((h,i)=>obj[h]=cols[i]!==undefined?cols[i].trim():'');
    Object.keys(obj).forEach(k=>{ if(isDash(obj[k])) obj[k]=''; });
    if(obj["Data"] && /^\d{2}[./]\d{2}[./]\d{4}$/.test(obj["Data"])){ const [d,m,y]=obj["Data"].replace(/\./g,'/').split('/').map(Number); obj["Data"]=toISODateLocal(y,m,d); }
    Object.keys(obj).forEach(k=>{
      if(PCT.has(k)) { obj[k]=normPct(obj[k]); return; }
      if(MONEY.has(k) || INTLIKE.has(k) || TONS.has(k)) { const n=asNumber(obj[k]); obj[k]=(n===''||!Number.isFinite(n))?'':n; }
      if(k==="Contagem cíclica"){ const n=asNumber(obj[k]); obj[k]=(n===''||!Number.isFinite(n))?'':n; }
    });
    if(obj["Volume (tons)"]===undefined||obj["Volume (tons)"]===''){ const vin=asNumber(obj["Volume In (tons)"])||0, vout=asNumber(obj["Volume Out (tons)"])||0; obj["Volume (tons)"]=(vin>0||vout>0)?(vin+vout):''; }
    return obj;
  });
}

/* METAS UI */
function openMetas(){const t=getTargets(); m_onTime.value=t.onTime; m_inFull.value=t.inFull; m_fillRate.value=t.fillRate; m_contagem.value=t.contagem; m_ila.value=t.ila; m_ira.value=t.ira; m_perdas.value=t.perdas; m_ocupacao.value=t.ocupacao; m_turnover.value=t.turnover; m_abs.value=t.abs; modalMetas.showModal();}
function saveMetas(){ const t={onTime:+(m_onTime.value||defaultTargets.onTime),inFull:+(m_inFull.value||defaultTargets.inFull),fillRate:+(m_fillRate.value||defaultTargets.fillRate),contagem:+(m_contagem.value||defaultTargets.contagem),ila:+(m_ila.value||defaultTargets.ila),ira:+(m_ira.value||defaultTargets.ira),perdas:+(m_perdas.value||defaultTargets.perdas),ocupacao:+(m_ocupacao.value||defaultTargets.ocupacao),turnover:+(m_turnover.value||defaultTargets.turnover),abs:+(m_abs.value||defaultTargets.abs)}; saveTargets(t); renderBadges(); refresh(); modalMetas.close(); }

/* Filtro por bloco */
const hasAnyForHeaders=(row,HEADERS)=> HEADERS.slice(2).some(h=>{ const v=row[h]; if(v===''||v==null) return false; const n=Number(v); return Number.isFinite(n)?n!==0:String(v).trim()!==''; });

/* HEADERS/TABELAS */
function renderHeadsOnce(){ if(!theadArm.hasChildNodes()) renderHead(theadArm,HEAD_ARM); if(!theadRH.hasChildNodes()) renderHead(theadRH,HEAD_RH); if(!theadTransp.hasChildNodes()) renderHead(theadTransp,HEAD_TRANSP); }
function refresh(){
  const enriched=DATA.map(r=>enrich({...r}));
  const filtered=applyFilters(enriched);
  const HEADERS=activeBlock===ROUTES.arm?HEAD_ARM:(activeBlock===ROUTES.rh?HEAD_RH:HEAD_TRANSP);
  const filteredForBlock=filtered.filter(r=>hasAnyForHeaders(r,HEADERS));
  const sum=summarize(filteredForBlock);
  renderBadges(); renderHeadsOnce(); renderCardsFor(activeBlock,sum);
  if(activeBlock===ROUTES.arm) renderBody(tbodyArm,HEAD_ARM,filteredForBlock,rowsArm);
  else if(activeBlock===ROUTES.rh) renderBody(tbodyRH,HEAD_RH,filteredForBlock,rowsRH);
  else renderBody(tbodyTransp,HEAD_TRANSP,filteredForBlock,rowsTransp);
}

/* === NOVO: carregar Excel do repositório no boot === */
async function loadExcelFromRepo(){
  try{
    const res = await fetch(EXCEL_URL, {cache:"no-store"});
    if(!res.ok) throw new Error(`Não encontrei ${EXCEL_URL} (HTTP ${res.status})`);
    const ab = await res.arrayBuffer();
    const wb = XLSX.read(ab,{type:'array'});
    const ws = wb.Sheets[EXCEL_SHEET] || wb.Sheets[wb.SheetNames[0]];
    if(!ws) throw new Error(`Aba não encontrada: ${EXCEL_SHEET||'(primeira aba)'}`);

    // Recorte igual ao seu upload: cabeçalho na linha 3 e começa na coluna B
    const ref = XLSX.utils.decode_range(ws['!ref']);
    ref.s.r = Math.max(ref.s.r, 2);  // linha 3 (0-based)
    ref.s.c = Math.max(ref.s.c, 1);  // coluna B (0-based)
    const newRef = XLSX.utils.encode_range(ref);

    let rows = XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
    rows = rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
    if(!rows.length) throw new Error("Planilha vazia após normalização.");
    DATA = rows;
    console.log('CARREGADO_DO_REPO:', {linhas: DATA.length, aba: (EXCEL_SHEET||wb.SheetNames[0])});
  }catch(err){
    console.warn("Falha ao carregar Excel do repositório:", err);
    // Mantém DATA como está (pode vir do seed-data) e o usuário ainda pode usar o botão de upload manual se quiser
  }
}

/* Inicialização UI (datas, abas, unidades) */
function bootstrap(){
  const hasData = Array.isArray(DATA) && DATA.length>0;
  const afterDataReady = ()=>{
    renderUnits(DATA);
    const minD=new Date(Math.min(...DATA.map(r=>+parseDateRaw(r.Data))));
    const maxD=new Date(Math.max(...DATA.map(r=>+parseDateRaw(r.Data))));
    if(!isNaN(minD)) dateStart.value=toISODateLocal(minD.getFullYear(),minD.getMonth()+1,minD.getDate());
    if(!isNaN(maxD)) dateEnd.value=toISODateLocal(maxD.getFullYear(),maxD.getMonth()+1,maxD.getDate());
    setActiveBlock(getActiveFromHash()); if(!location.hash) history.replaceState(null,'','#'+activeBlock);
  };

  if(hasData){
    afterDataReady();
  }else{
    // tenta Excel estático do repositório
    loadExcelFromRepo().then(afterDataReady);
  }
}

/* EVENTOS */
dateStart.addEventListener('change',refresh);
dateEnd.addEventListener('change',refresh);
btnReset.addEventListener('click',()=>{ dateStart.value=''; dateEnd.value=''; UNIT_STATE.forEach(x=>x.on=true); updateUnitPills(); refresh(); });
btnMetas.addEventListener('click',openMetas);
closeMetas.addEventListener('click',e=>{e.preventDefault();modalMetas.close();});
btnSalvarMetas.addEventListener('click',e=>{e.preventDefault();saveMetas();});
modalMetas.addEventListener('cancel',()=>modalMetas.close());

/* IMPORTAÇÃO MANUAL (fallback opcional) */
csvInput.addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  if(/\.(xlsx|xls)$/i.test(f.name)){
    const ab=await f.arrayBuffer(); const wb=XLSX.read(ab,{type:'array'}); const ws=wb.Sheets['Base']||wb.Sheets[wb.SheetNames[0]];
    const ref=XLSX.utils.decode_range(ws['!ref']); ref.s.r=Math.max(ref.s.r,2); ref.s.c=Math.max(ref.s.c,1); const newRef=XLSX.utils.encode_range(ref);
    let rows=XLSX.utils.sheet_to_json(ws,{defval:"",range:newRef});
    rows=rows.map(normalizeRow).filter(o=>!isRowAllBlank(o));
    DATA=rows; console.log('COPIE_ESSE_JSON:', JSON.stringify(DATA));
  }else{
    DATA=parseCSV(await f.text()).map(normalizeRow).filter(o=>!isRowAllBlank(o));
    console.log('COPIE_ESSE_JSON:', JSON.stringify(DATA));
    if(!DATA.length) return alert('Arquivo vazio ou inválido.');
  }
  renderUnits(DATA); updateUnitPills();
  const minD=new Date(Math.min(...DATA.map(r=>+parseDateRaw(r.Data)))); const maxD=new Date(Math.max(...DATA.map(r=>+parseDateRaw(r.Data))));
  if(!isNaN(minD)) dateStart.value=toISODateLocal(minD.getFullYear(),minD.getMonth()+1,minD.getDate());
  if(!isNaN(maxD)) dateEnd.value=toISODateLocal(maxD.getFullYear(),maxD.getMonth()+1,maxD.getDate());
  refresh();
});

/* START */
bootstrap();

/* Ajuste responsivo dos cards */
(function(){
  const cont=document.getElementById('cards'); if(!cont) return;
  let rafId=null;
  function fit(){ const items=[...cont.children]; if(!items.length) return; const gap=12,total=items.length,w=cont.clientWidth||cont.offsetWidth; let cw=Math.floor((w-gap*(total-1))/total); cw=Math.max(96,Math.min(210,cw)); cont.style.setProperty('--cardW',cw+'px'); items.forEach(el=>el.style.width=cw+'px'); }
  const mo=new MutationObserver(()=>{ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(fit); });
  mo.observe(cont,{childList:true});
  const ro=new ResizeObserver(()=>{ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(fit); });
  ro.observe(cont);
  window.addEventListener('resize',()=>{ cancelAnimationFrame(rafId); rafId=requestAnimationFrame(fit); });
  requestAnimationFrame(fit);
})();
</script>
</body>
</html>
